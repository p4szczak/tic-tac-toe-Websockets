<!doctype html>
<html>
  <head>
    <title>Tic-Tac-Toe Menu</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div id="panel">
        <h1>Tic-Tac-Toe Websockets</h1>
        <form>
            <h2>Create new room</h2>
            <label>Name:</label>
            <input type="text" id="player1" name="player1">
            <button id="create">Create room</button>
            <br><br>
            <h2>Join to room</h2>
            <label>Name:</label>
            <input type="text" id="player2" name="player2">
            <label>Room id</label>
            <input type="text" id="room" name="room">
            <button id="join">Join room</button>
        </form>
        <canvas id="game" width="300" height="300" style="border:1px solid #d3d3d3;"></canvas>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        $(function () {

            var p1 = 'X';
            var p2 = 'O';
            var socket = io();
            var player;
            var game;
            var room;
            var turnCounter = 0;

            function relMouseCoords(event){
                var totalOffsetX = 0;
                var totalOffsetY = 0;
                var canvasX = 0;
                var canvasY = 0;
                var currentElement = this;
    
                do{
                    totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
                    totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
                }
                while(currentElement = currentElement.offsetParent)
    
                canvasX = event.pageX - totalOffsetX;
                canvasY = event.pageY - totalOffsetY;
    
                return {x:canvasX, y:canvasY}
            }
            HTMLCanvasElement.prototype.relMouseCoords = relMouseCoords;
            
            function drawBoard(){
                var ctx = document.getElementById("game").getContext("2d");
                ctx.clearRect(0, 0, 300, 300);
                ctx.beginPath();
                ctx.moveTo(100,0);
                ctx.lineTo(100,300);
                ctx.moveTo(200,0);
                ctx.lineTo(200,300);
                ctx.moveTo(0,100);
                ctx.lineTo(300,100);
                ctx.moveTo(0,200);
                ctx.lineTo(300,200);
                ctx.stroke();
            }

            function drawOnCanvas(elem, type){
                var ctx= document.getElementById("game").getContext("2d");
                ctx.font="60px Georgia";
                var moveX = 100;
                var moveY; 
                if(elem > 2 && elem <= 5)
                    moveY = 100;
                else if (elem > 5)
                    moveY = 200;
                else
                    moveY = 0;

                ctx.fillText(type, 25 + elem % 3 * moveX, 70 + moveY);
            }

            function checkVictory(){
                
                if (turnCounter >= 9) return 2;
                //vertical
                else  if(game[0] == game[3] && game[0] == game[6] && game[0] != 0) return 1;
                else if(game[1] == game[4] && game[1] == game[7] && game[1] != 0) return 1;
                else if(game[2] == game[5] && game[2] == game[8] && game[2] != 0) return 1;
                //horizontal
                else if(game[0] == game[1] && game[0] == game[2] && game[0] != 0) return 1;
                else if(game[3] == game[4] && game[4] == game[5] && game[3] != 0) return 1;
                else if(game[6] == game[7] && game[6] == game[8] && game[6] != 0) return 1;
                //cross
                else if(game[0] == game[4] && game[0] == game[8] && game[0] != 0) return 1;
                else if(game[2] == game[4] && game[2] == game[6] && game[2] != 0) return 1;
                
                else return 0;
                
            }

            class Player{
                constructor(name, type){
                    this.name = name;
                    this.type = type;
                    this.numType = type == 'X' ? 1 : 2;
                    this.turn = false;
                }
                getTurn(){
                    return this.turn;
                }

                setTurn(turn){
                    this.turn = turn;
                }
                getType(){
                    return this.type;
                }

                getNumType(){
                    return this.numType;
                }
            }

            $('#create').on('click', function(){
                socket.emit('roomCreation', $("#player1").val());
                player = new Player($("#player1").val(), p1);
                return false;
            });
            
            $('#join').on('click', function(){
                room = $("#room").val();
                socket.emit('roomJoin', room + ";" + $("#player2").val());
                player = new Player($("#player2").val(), p2);
                return false;
            });

            socket.on('newRoom', function(msg){
                alert('Room created: ' + msg);
                room = msg;
                drawBoard();
                game = [0,0,0,0,0,0,0,0,0];
            });

            socket.on('player1', function(msg){
                alert('Enemy connected: ' + msg);
                player.setTurn(true);
            });

            socket.on('player2', function(msg){
                alert('You have successfuly connected to: ' + msg);
                drawBoard();
                game = [0,0,0,0,0,0,0,0,0];
            });

            socket.on('turn',function(msg){
                turnCounter++;
                player.setTurn(true);
                var recvBufView = new Uint8Array(msg);
                console.log(recvBufView);
                var enemyNumType = player.getNumType() + 1 % 2;
                var enemyType = player.getType() == 'X' ? 'O' : 'X';
                
                game[recvBufView[0]] = enemyNumType;
                drawOnCanvas(recvBufView[0], enemyType);
                if(recvBufView[1] == 1){
                    alert('You lose!');
                }
                else if (recvBufView[1] == 2){
                    alert('Draw...');
                }
            });

            socket.on('err', function(msg){
                alert('Error: ' + msg);
            });

            $('#game').on('click', function(){
                var cords = document.getElementById("game").relMouseCoords(event);
                var elem;
                if(cords.x < 100 && cords.y < 100) elem = 0
                else if(cords.x>100 && cords.x <= 200 && cords.y < 100) elem = 1
                else if(cords.x>200 && cords.x <= 300 && cords.y < 100) elem = 2
                else if(cords.x < 100 && cords.y < 200 && cords.y > 100) elem = 3
                else if(cords.x>100 && cords.x <= 200 && cords.y < 200 && cords.y > 100) elem = 4
                else if(cords.x>200 && cords.x <= 300 && cords.y < 200 && cords.y > 100) elem = 5
                else if(cords.x < 100 && cords.y < 300 && cords.y > 200) elem = 6
                else if(cords.x>100 && cords.x <= 200 && cords.y < 300 && cords.y > 200) elem = 7
                else if(cords.x>200 && cords.x <= 300 && cords.y < 300 && cords.y > 200) elem = 8

                if(game[elem] == 0 && player.getTurn()){
                    drawOnCanvas(elem, player.getType());
                    game[elem] = player.getNumType();
                    turnCounter++;
                    var bufArr = new ArrayBuffer(3);
                    var bufView = new Uint8Array(bufArr);
                    bufView[0] = room;
                    bufView[1] = elem;
                    bufView[2] = checkVictory();
                    socket.emit('turn', bufArr);
                    if(checkVictory() == 2){
                        alert('Draw...');
                    }
                    else if(checkVictory() == 1){
                        alert('You won!');
                    }
                    
                    player.setTurn(false);
                    
                }
                               
                return false;
            });
        });
    </script>
  </body>
</html>